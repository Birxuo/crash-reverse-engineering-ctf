from ib_insync import *
import math
import time

# ----------------------------
#  CONFIGURATION
# ----------------------------
HOST = '127.0.0.1'
PORT = 4002          # Paper / TWS can differ
CLIENT_ID = 1
SYMBOL = 'AAPL'
EXCHANGE = 'SMART'
CURRENCY = 'USD'
FALLBACK_PRICE = 1.0


# ----------------------------
#  MAIN
# ----------------------------

def main():

    ib = IB()

    # ----------------------------
    # Connect to IB Gateway / TWS
    # ----------------------------
    try:
        ib.connect(HOST, PORT, clientId=CLIENT_ID)
        print("[OK] Connected to IB Gateway")
    except Exception as e:
        print("[ERROR] Cannot connect:", e)
        return

    # ----------------------------
    # Force delayed market data 
    # ----------------------------
    ib.reqMarketDataType(3)   # 1=Real, 2=Frozen, 3=Delayed
    print("[INFO] Using delayed market data")

    # ----------------------------
    # Define contract
    # ----------------------------
    contract = Stock(SYMBOL, EXCHANGE, CURRENCY)
    ib.qualifyContracts(contract)

    # ----------------------------
    # Request market data
    # ----------------------------
    ticker = ib.reqMktData(contract, '', False, False)
    time.sleep(2)  # allow data to populate

    # ----------------------------
    # Read and validate price
    # ----------------------------
    price = ticker.last

    if price is None or math.isnan(price):
        print(f"[WARN] Market data returned invalid price: {price}")
        print(f"[WARN] Using fallback price: {FALLBACK_PRICE}")
        price = FALLBACK_PRICE
    else:
        print(f"[OK] Last price for {SYMBOL}: {price}")

    # ----------------------------
    # Create limit order
    # ----------------------------
    order = LimitOrder('BUY', 1, price)
    print(f"[SEND] Sending limit order @ {price}")

    trade = ib.placeOrder(contract, order)
    time.sleep(2)

    # ----------------------------
    # Order Status
    # ----------------------------
    print("[INFO] Order Status:", trade.orderStatus.status)

    # ----------------------------
    # Disconnect
    # ----------------------------
    ib.disconnect()
    print("[OK] Disconnected from IB Gateway")


# ----------------------------
# Run
# ----------------------------
if __name__ == "__main__":
    main()